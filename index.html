<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EmuTalk Chat</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: #f5f5f5;
    display: flex; flex-direction: column; height: 100vh;
  }
  header {
    background: #2c3e50;
    color: #ecf0f1;
    padding: 10px 15px;
    display: flex; align-items: center; justify-content: space-between;
  }
  header input[type="text"] {
    font-size: 16px;
    padding: 5px 8px;
    border-radius: 4px;
    border: none;
    width: 180px;
  }
  main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }
  #users {
    width: 180px;
    background: #ecf0f1;
    padding: 10px;
    box-sizing: border-box;
    overflow-y: auto;
    border-right: 1px solid #bdc3c7;
  }
  #users h3 {
    margin-top: 0;
    font-weight: normal;
    color: #34495e;
  }
  #users ul {
    list-style: none;
    padding: 0; margin: 0;
  }
  #users li {
    padding: 6px 4px;
    border-bottom: 1px solid #bdc3c7;
    color: #2c3e50;
    font-weight: 600;
  }
  #chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    background: #fff;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #bdc3c7;
  }
  #messages .message {
    margin-bottom: 8px;
  }
  #messages .message strong {
    color: #2980b9;
  }
  form {
    margin-top: 10px;
    display: flex;
  }
  form input[type="text"] {
    flex: 1;
    padding: 8px;
    font-size: 16px;
    border-radius: 4px 0 0 4px;
    border: 1px solid #bdc3c7;
    border-right: none;
    outline: none;
  }
  form button {
    padding: 8px 15px;
    font-size: 16px;
    border-radius: 0 4px 4px 0;
    border: 1px solid #bdc3c7;
    background: #2980b9;
    color: white;
    cursor: pointer;
  }
  form button:hover {
    background: #3498db;
  }
</style>
</head>
<body>

<header>
  <div>
    Name: <input type="text" id="username" maxlength="20" />
  </div>
</header>

<main>
  <aside id="users">
    <h3>Users</h3>
    <ul id="userList"></ul>
  </aside>

  <section id="chat">
    <div id="messages"></div>
    <form id="msgForm">
      <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off" />
      <button type="submit">Send</button>
    </form>
  </section>
</main>

<!-- Firebase SDK v7.20.0 compatibility libraries -->
<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>

<script>
  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCma57Lei7tJb8QQfGhrpajyUZDJUZv2jY",
    authDomain: "emutalk-45883.firebaseapp.com",
    databaseURL: "https://emutalk-45883-default-rtdb.firebaseio.com", // You must add this in Firebase Realtime DB
    projectId: "emutalk-45883",
    storageBucket: "emutalk-45883.appspot.com",
    messagingSenderId: "346180779740",
    appId: "1:346180779740:web:dbfc2e746ee071957b3e19",
    measurementId: "G-84LK95DF4Q"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Elements
  const usernameInput = document.getElementById('username');
  const userListEl = document.getElementById('userList');
  const messagesEl = document.getElementById('messages');
  const msgForm = document.getElementById('msgForm');
  const msgInput = document.getElementById('msgInput');

  // User state
  let username = localStorage.getItem('chatUsername') || 'Anonymous';

  // Save username input
  usernameInput.value = username;
  usernameInput.addEventListener('change', () => {
    username = usernameInput.value.trim() || 'Anonymous';
    localStorage.setItem('chatUsername', username);
    updateUserPresence();
  });

  // Track presence in users list
  // Generate a persistent-ish id stored locally:
  let userId = localStorage.getItem('chatUserId');
  if (!userId) {
    userId = 'user_' + Math.random().toString(36).slice(2,10);
    localStorage.setItem('chatUserId', userId);
  }

  const userRef = db.ref('users/' + userId);
  function updateUserPresence() {
    userRef.set({ name: username, lastSeen: Date.now() });
  }
  updateUserPresence();

  // Remove user on disconnect
  userRef.onDisconnect().remove();

  // Update presence every 30 sec
  setInterval(updateUserPresence, 30000);

  // Listen for user list changes
  db.ref('users').on('value', snapshot => {
    const users = snapshot.val() || {};
    userListEl.innerHTML = '';
    Object.values(users).forEach(u => {
      const li = document.createElement('li');
      li.textContent = u.name || 'Anonymous';
      userListEl.appendChild(li);
    });
  });

  // Listen for new messages
  db.ref('messages').limitToLast(100).on('child_added', snapshot => {
    const msg = snapshot.val();
    if (!msg) return;
    const div = document.createElement('div');
    div.classList.add('message');
    div.innerHTML = `<strong>${escapeHTML(msg.user)}:</strong> ${escapeHTML(msg.text)}`;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

  // Send message
  msgForm.addEventListener('submit', e => {
    e.preventDefault();
    const text = msgInput.value.trim();
    if (!text) return;
    db.ref('messages').push({
      user: username,
      text: text,
      ts: Date.now()
    });
    msgInput.value = '';
  });

  // Helper to escape HTML (simple)
  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, function(m) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }
</script>

</body>
</html>
