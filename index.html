<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EmuTalk Chat</title>
<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
    background: #fefefe;
    display: flex; flex-direction: column; height: 100vh;
    color: #222;
  }
  header {
    background: #34495e;
    color: #ecf0f1;
    padding: 10px 15px;
    display: flex; align-items: center; justify-content: space-between;
    user-select: none;
  }
  header .left-section {
    display: flex; align-items: center; gap: 12px;
  }
  header label {
    font-weight: 600;
    margin-right: 6px;
    font-size: 14px;
  }
  header input[type="text"] {
    font-size: 16px;
    padding: 6px 10px;
    border-radius: 4px;
    border: none;
    width: 160px;
    outline-offset: 2px;
  }
  header input[type="text"]:focus {
    outline: 2px solid #2980b9;
  }
  header button {
    background: #2980b9;
    border: none;
    color: white;
    font-weight: 600;
    padding: 6px 12px;
    margin-left: 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.25s ease;
  }
  header button:hover {
    background: #3498db;
  }

  main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }
  #users {
    width: 200px;
    background: #ecf0f1;
    padding: 10px;
    box-sizing: border-box;
    overflow-y: auto;
    border-right: 1px solid #bdc3c7;
  }
  #users h3 {
    margin-top: 0;
    font-weight: 700;
    color: #2c3e50;
    border-bottom: 2px solid #2980b9;
    padding-bottom: 6px;
    user-select: none;
  }
  #users ul {
    list-style: none;
    padding: 0; margin: 0;
  }
  #users li {
    padding: 8px 6px;
    border-bottom: 1px solid #bdc3c7;
    color: #34495e;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 12px;
    box-sizing: border-box;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    background: #fff;
    padding: 14px;
    border-radius: 6px;
    border: 1px solid #bdc3c7;
    font-size: 15px;
    line-height: 1.35;
  }
  #messages .message {
    margin-bottom: 12px;
  }
  #messages .message strong {
    color: #2980b9;
  }
  form {
    margin-top: 12px;
    display: flex;
    gap: 6px;
  }
  form input[type="text"] {
    flex: 1;
    padding: 10px 12px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #bdc3c7;
    outline-offset: 2px;
    transition: border-color 0.2s ease;
  }
  form input[type="text"]:focus {
    border-color: #2980b9;
  }
  form button {
    padding: 10px 20px;
    font-size: 16px;
    border-radius: 6px;
    border: none;
    background: #2980b9;
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.25s ease;
  }
  form button:hover {
    background: #3498db;
  }

  /* Modal backgrounds */
  .modal-bg {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }
  .modal-bg.active {
    display: flex;
  }

  /* Modal container */
  .modal {
    background: white;
    border-radius: 10px;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    padding: 20px 24px;
    position: relative;
    font-size: 15px;
    user-select: text;
  }
  .modal h2 {
    margin-top: 0;
    font-weight: 700;
    color: #2980b9;
    user-select: text;
  }
  .modal .close-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    border: none;
    background: none;
    font-size: 24px;
    font-weight: 700;
    color: #888;
    cursor: pointer;
    transition: color 0.2s ease;
    user-select: none;
  }
  .modal .close-btn:hover {
    color: #2980b9;
  }
  /* Settings content */
  .settings-group {
    margin-bottom: 18px;
  }
  .settings-group h3 {
    margin-bottom: 8px;
    color: #34495e;
  }
  .settings-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    gap: 12px;
  }
  .settings-item label {
    flex: 1;
    cursor: pointer;
  }
  .settings-item input[type="checkbox"],
  .settings-item input[type="range"],
  .settings-item select {
    cursor: pointer;
  }
  .settings-item input[type="range"] {
    width: 100px;
  }

  /* Scrollbar styling for user list and messages */
  #users::-webkit-scrollbar,
  #messages::-webkit-scrollbar,
  .modal::-webkit-scrollbar {
    width: 8px;
  }
  #users::-webkit-scrollbar-thumb,
  #messages::-webkit-scrollbar-thumb,
  .modal::-webkit-scrollbar-thumb {
    background-color: #2980b9;
    border-radius: 4px;
  }
</style>
</head>
<body>

<header>
  <div class="left-section">
    <label for="username">Name:</label>
    <input type="text" id="username" maxlength="20" title="Edit your username" autocomplete="off" />
  </div>
  <div class="right-section">
    <button id="btnSettings" title="Settings">Settings ‚öôÔ∏è</button>
    <button id="btnRules" title="Rules">Rules üìú</button>
  </div>
</header>

<main>
  <aside id="users" aria-label="Active users list">
    <h3>Users</h3>
    <ul id="userList" role="list"></ul>
  </aside>

  <section id="chat" aria-label="Chat messages and input">
    <div id="messages" role="log" aria-live="polite" aria-relevant="additions"></div>
    <form id="msgForm" aria-label="Send a message">
      <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off" />
      <button type="submit">Send</button>
    </form>
  </section>
</main>

<!-- Settings Modal -->
<div id="modalSettings" class="modal-bg" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" tabindex="-1">
  <div class="modal">
    <button class="close-btn" aria-label="Close settings modal" title="Close settings">&times;</button>
    <h2 id="settingsTitle">Settings</h2>
    <form id="settingsForm">
      <!-- We'll fill these dynamically with JS -->
    </form>
  </div>
</div>

<!-- Rules Modal -->
<div id="modalRules" class="modal-bg" role="dialog" aria-modal="true" aria-labelledby="rulesTitle" tabindex="-1">
  <div class="modal">
    <button class="close-btn" aria-label="Close rules modal" title="Close rules">&times;</button>
    <h2 id="rulesTitle">Chat Rules</h2>
    <ul>
      <li>No use of the N-word or other hateful slurs.</li>
      <li>Swearing is allowed but be respectful.</li>
      <li>No spamming or flooding the chat.</li>
      <li>No personal attacks or harassment.</li>
      <li>Do not share personal information.</li>
      <li>Follow all applicable laws and terms of service.</li>
      <li>Keep content appropriate for a general audience.</li>
      <li>Report violations to moderators if any.</li>
      <li>Have fun and be kind!</li>
    </ul>
  </div>
</div>

<!-- Firebase SDK v7.20.0 compatibility libraries -->
<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>

<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCma57Lei7tJb8QQfGhrpajyUZDJUZv2jY",
    authDomain: "emutalk-45883.firebaseapp.com",
    databaseURL: "https://emutalk-45883-default-rtdb.firebaseio.com",
    projectId: "emutalk-45883",
    storageBucket: "emutalk-45883.appspot.com",
    messagingSenderId: "346180779740",
    appId: "1:346180779740:web:dbfc2e746ee071957b3e19",
    measurementId: "G-84LK95DF4Q"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Elements
  const usernameInput = document.getElementById('username');
  const userListEl = document.getElementById('userList');
  const messagesEl = document.getElementById('messages');
  const msgForm = document.getElementById('msgForm');
  const msgInput = document.getElementById('msgInput');

  // Modal elements
  const modalSettings = document.getElementById('modalSettings');
  const modalRules = document.getElementById('modalRules');
  const btnSettings = document.getElementById('btnSettings');
  const btnRules = document.getElementById('btnRules');

  // Persistent user data
  let username = localStorage.getItem('chatUsername') || 'Anonymous';
  let userId = localStorage.getItem('chatUserId');
  if (!userId) {
    userId = 'user_' + Math.random().toString(36).slice(2, 10);
    localStorage.setItem('chatUserId', userId);
  }

  // Initialize username input
  usernameInput.value = username;
  usernameInput.addEventListener('change', () => {
    username = usernameInput.value.trim() || 'Anonymous';
    localStorage.setItem('chatUsername', username);
    updateUserPresence();
  });

  // User presence reference & update
  const userRef = db.ref('users/' + userId);
  function updateUserPresence() {
    userRef.set({ name: username, lastSeen: Date.now() });
  }
  updateUserPresence();
  userRef.onDisconnect().remove();
  setInterval(updateUserPresence, 30000);

  // Listen for user list changes
  db.ref('users').on('value', snapshot => {
    const users = snapshot.val() || {};
    userListEl.innerHTML = '';
    Object.values(users).forEach(u => {
      const li = document.createElement('li');
      li.textContent = u.name || 'Anonymous';
      userListEl.appendChild(li);
    });
  });

  // Listen for new messages
  db.ref('messages').limitToLast(100).on('child_added', snapshot => {
    const msg = snapshot.val();
    if (!msg) return;
    const div = document.createElement('div');
    div.classList.add('message');
    div.innerHTML = `<strong>${escapeHTML(msg.user)}:</strong> ${escapeHTML(msg.text)}`;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

  // Send message handler
  msgForm.addEventListener('submit', e => {
    e.preventDefault();
    const text = msgInput.value.trim();
    if (!text) return;
    db.ref('messages').push({
      user: username,
      text,
      ts: Date.now()
    });
    msgInput.value = '';
  });

  // Escape HTML to avoid injection
  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Modal open/close helpers
  function openModal(modal) {
    modal.classList.add('active');
    modal.focus();
  }
  function closeModal(modal) {
    modal.classList.remove('active');
  }

  // Settings data template
  const settingsData = [
    // Typing & display
    { id: 'typingSounds', label: 'Enable typing sounds', type: 'checkbox', default: false },
    { id: 'showOnscreenKeyboard', label: 'Show onscreen keyboard', type: 'checkbox', default: false },
    { id: 'fontSize', label: 'Chat font size', type: 'range', min: 12, max: 28, default: 15 },
    { id: 'darkTheme', label: 'Enable dark theme', type: 'checkbox', default: false },
    { id: 'messageAnimations', label: 'Enable message animations', type: 'checkbox', default: true },
    { id: 'showTimestamps', label: 'Show timestamps on messages', type: 'checkbox', default: true },
    { id: 'emojiSupport', label: 'Enable emoji support', type: 'checkbox', default: true },
    { id: 'autoScroll', label: 'Auto scroll chat on new messages', type: 'checkbox', default: true },
    { id: 'playSendSound', label: 'Play sound on message send', type: 'checkbox', default: true },
    { id: 'showUserColors', label: 'Show user colors', type: 'checkbox', default: true },
    // Sounds
    { id: 'soundVolume', label: 'Master sound volume', type: 'range', min: 0, max: 100, default: 80 },
    { id: 'typingSoundVolume', label: 'Typing sound volume', type: 'range', min: 0, max: 100, default: 50 },
    // Visual flair
    { id: 'enableBackgroundEffects', label: 'Enable background effects', type: 'checkbox', default: false },
    { id: 'confettiOnJoin', label: 'Show confetti when a user joins', type: 'checkbox', default: false },
    { id: 'showMessageBadges', label: 'Show badges on messages', type: 'checkbox', default: true },
    { id: 'compactMode', label: 'Enable compact chat mode', type: 'checkbox', default: false },
    // Keyboard & input
    { id: 'enterToSend', label: 'Press Enter to send message', type: 'checkbox', default: true },
    { id: 'showTypingIndicator', label: 'Show typing indicator', type: 'checkbox', default: true },
    { id: 'messageMaxLength', label: 'Max message length', type: 'range', min: 20, max: 500, default: 200 },
    // Fun stuff
    { id: 'enableAnimations', label: 'Enable fun animations', type: 'checkbox', default: true },
    { id: 'showTypingPreview', label: 'Show typing preview', type: 'checkbox', default: false },
    { id: 'autoTranslate', label: 'Auto translate messages (beta)', type: 'checkbox', default: false },
    { id: 'enableMessageSounds', label: 'Enable message received sounds', type: 'checkbox', default: true },
    { id: 'showReadReceipts', label: 'Show read receipts', type: 'checkbox', default: false },
    { id: 'showAvatar', label: 'Show user avatars', type: 'checkbox', default: false },
    { id: 'avatarSize', label: 'Avatar size', type: 'range', min: 16, max: 64, default: 32 },
    { id: 'showUserStatus', label: 'Show user online status', type: 'checkbox', default: true },
    { id: 'enableSoundEffects', label: 'Enable sound effects', type: 'checkbox', default: true },
    { id: 'enableChatBorders', label: 'Enable chat borders', type: 'checkbox', default: true },
    { id: 'messageBackgroundOpacity', label: 'Message background opacity', type: 'range', min: 0, max: 100, default: 90 },
    { id: 'showMentionsHighlight', label: 'Highlight mentions', type: 'checkbox', default: true },
    { id: 'highlightColor', label: 'Mention highlight color', type: 'select', options: ['#ffff00', '#ff9a9a', '#9aff9a', '#9ac8ff', '#ff9aff'], default: '#ffff00' },
    { id: 'showTypingSoundWaves', label: 'Show typing sound waves', type: 'checkbox', default: false },
    { id: 'showMessageLinksPreview', label: 'Show message links preview', type: 'checkbox', default: true },
    { id: 'enableEmojiReactions', label: 'Enable emoji reactions', type: 'checkbox', default: true },
    { id: 'enableBotResponses', label: 'Enable bot responses', type: 'checkbox', default: false },
    { id: 'botResponseDelay', label: 'Bot response delay (seconds)', type: 'range', min: 0, max: 10, default: 2 },
    { id: 'autoSaveMessages', label: 'Auto-save chat history locally', type: 'checkbox', default: true },
    { id: 'showMessageEditButton', label: 'Allow editing own messages', type: 'checkbox', default: false },
    { id: 'showDeleteButton', label: 'Allow deleting own messages', type: 'checkbox', default: false },
    { id: 'showUserJoinLeaveMessages', label: 'Show user join/leave messages', type: 'checkbox', default: true },
    { id: 'showChannelTyping', label: 'Show typing in channels', type: 'checkbox', default: true },
    { id: 'enableMessageFormatting', label: 'Enable markdown formatting', type: 'checkbox', default: true },
    { id: 'enableCodeBlocks', label: 'Enable code blocks formatting', type: 'checkbox', default: true },
    { id: 'enableDarkCodeBlocks', label: 'Enable dark style code blocks', type: 'checkbox', default: false },
    { id: 'enableSoundNotification', label: 'Enable sound notifications', type: 'checkbox', default: true },
    { id: 'soundNotificationVolume', label: 'Notification sound volume', type: 'range', min: 0, max: 100, default: 70 },
    { id: 'enableChatAutoScroll', label: 'Enable auto scroll', type: 'checkbox', default: true },
    { id: 'showChatScrollbar', label: 'Show chat scrollbar', type: 'checkbox', default: true }
  ];

  // Load and save settings in localStorage
  const settingsForm = document.getElementById('settingsForm');
  function loadSettings() {
    settingsData.forEach(s => {
      let val = localStorage.getItem('setting_' + s.id);
      if(val === null) val = s.default;
      else if(s.type === 'checkbox') val = val === 'true';
      else if(s.type === 'range') val = Number(val);
      else if(s.type === 'select') val = val;
      s.current = val;
    });
  }
  function saveSettings() {
    settingsData.forEach(s => {
      localStorage.setItem('setting_' + s.id, s.current);
    });
  }
  function buildSettingsForm() {
    settingsForm.innerHTML = '';
    settingsData.forEach(setting => {
      const group = document.createElement('div');
      group.className = 'settings-item';

      let input;
      if(setting.type === 'checkbox') {
        input = document.createElement('input');
        input.type = 'checkbox';
        input.id = setting.id;
        input.checked = setting.current;
        input.addEventListener('change', e => {
          setting.current = e.target.checked;
          saveSettings();
          applySettings();
        });
      } else if(setting.type === 'range') {
        input = document.createElement('input');
        input.type = 'range';
        input.id = setting.id;
        input.min = setting.min;
        input.max = setting.max;
        input.value = setting.current;
        input.addEventListener('input', e => {
          setting.current = e.target.value;
          labelValue.textContent = e.target.value;
          saveSettings();
          applySettings();
        });
      } else if(setting.type === 'select') {
        input = document.createElement('select');
        input.id = setting.id;
        setting.options.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          if(opt === setting.current) option.selected = true;
          input.appendChild(option);
        });
        input.addEventListener('change', e => {
          setting.current = e.target.value;
          saveSettings();
          applySettings();
        });
      }

      const label = document.createElement('label');
      label.htmlFor = setting.id;
      label.textContent = setting.label;

      group.appendChild(input);
      group.appendChild(label);

      // For range, show value next to slider
      let labelValue;
      if(setting.type === 'range') {
        labelValue = document.createElement('span');
        labelValue.style.marginLeft = '8px';
        labelValue.style.minWidth = '30px';
        labelValue.textContent = setting.current;
        group.appendChild(labelValue);
      }

      // Arrange label after checkbox for better UX
      if(setting.type === 'checkbox') {
        group.insertBefore(label, input);
      }

      settingsForm.appendChild(group);
    });
  }

  // Apply some settings to chat UI dynamically
  function applySettings() {
    const dark = settingsData.find(s => s.id === 'darkTheme').current;
    if(dark) {
      document.body.style.background = '#121212';
      document.body.style.color = '#ddd';
      messagesEl.style.background = '#222';
      messagesEl.style.color = '#eee';
      userListEl.style.background = '#222';
      userListEl.style.color = '#ddd';
      document.querySelector('header').style.background = '#222';
    } else {
      document.body.style.background = '#fefefe';
      document.body.style.color = '#222';
      messagesEl.style.background = '#fff';
      messagesEl.style.color = '#222';
      userListEl.style.background = '#ecf0f1';
      userListEl.style.color = '#34495e';
      document.querySelector('header').style.background = '#34495e';
    }

    // Font size
    const fontSize = settingsData.find(s => s.id === 'fontSize').current;
    messagesEl.style.fontSize = fontSize + 'px';

    // Compact mode - adjust message margin
    const compact = settingsData.find(s => s.id === 'compactMode').current;
    if(compact) {
      messagesEl.querySelectorAll('.message').forEach(msg => {
        msg.style.marginBottom = '4px';
      });
    } else {
      messagesEl.querySelectorAll('.message').forEach(msg => {
        msg.style.marginBottom = '12px';
      });
    }
  }

  // Open/close modal events
  btnSettings.addEventListener('click', () => openModal(modalSettings));
  btnRules.addEventListener('click', () => openModal(modalRules));
  [...document.querySelectorAll('.modal .close-btn')].forEach(btn => {
    btn.addEventListener('click', e => {
      closeModal(e.target.closest('.modal-bg'));
    });
  });

  // Close modal on clicking outside modal box
  [modalSettings, modalRules].forEach(modal => {
    modal.addEventListener('click', e => {
      if(e.target === modal) closeModal(modal);
    });
  });

  // Close modal on Escape key
  document.addEventListener('keydown', e => {
    if(e.key === 'Escape') {
      [modalSettings, modalRules].forEach(modal => {
        if(modal.classList.contains('active')) closeModal(modal);
      });
    }
  });

  // Initial load settings, build form and apply
  loadSettings();
  buildSettingsForm();
  applySettings();

</script>
</body>
</html>
